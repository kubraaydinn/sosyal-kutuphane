{% extends "base.html" %}
{% block title %}{{ content.title }} - Sosyal Kütüphane{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        {% if content.poster_url %}
            <img src="{{ content.poster_url }}" class="img-fluid mb-3" alt="Poster">
        {% else %}
            <div class="bg-light border d-flex align-items-center justify-content-center" style="height: 300px;">
                <span class="text-muted">Poster yok</span>
            </div>
        {% endif %}
    </div>

    <div class="col-md-9">
        <h2>{{ content.title }}</h2>
        <p class="text-muted mb-1">
            Tür: {{ "Film" if content.type == "movie" else "Kitap" }}
            {% if content.year %} · {{ content.year }}{% endif %}
        </p>

        <p class="mb-2">
            {% if avg_rating %}
                Ortalama Puan: <strong>{{ "%.1f"|format(avg_rating) }}/10</strong>
            {% else %}
                Henüz puanlanmamış.
            {% endif %}
        </p>

        {% if meta.director %}
            <p class="mb-1">
                <strong>Yönetmen:</strong> {{ meta.director }}
            </p>
        {% endif %}
        
        {% if meta.genres %}
            <p class="mb-1">
                <strong>Türler:</strong> {{ meta.genres | join(", ") }}
            </p>
        {% endif %}
        
        {% if meta.cast %}
            <p class="mb-3">
                <strong>Oyuncular:</strong> {{ meta.cast | join(", ") }}
            </p>
        {% endif %}
        
        {% if meta.overview %}
            <div class="mb-4">
                <h5>Özet</h5>
                <p>{{ meta.overview }}</p>
            </div>
        {% endif %}


        <hr>

        <!-- Puan verme formu -->
        <h5>Puan Ver</h5>
        <form method="post" class="row g-2 mb-4">
            <div class="col-auto">
                <select name="score" class="form-select">
                    {% for s in range(1, 11) %}
                        <option value="{{ s }}"
                                {% if user_rating and user_rating.score == s %}selected{% endif %}>
                            {{ s }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">
                    Kaydet
                </button>
            </div>
        </form>

                   <!--<hr>-->

        <!-- Listelere ekle -->
        <h5>Listelere Ekle</h5>
        <form method="post" class="row g-2 mb-4">
            <div class="col-auto">
                <select name="list_id" class="form-select">
                    {% for lst in user_lists %}
                        {% set in_list = lst.items.filter_by(content_id=content.id).first() %}
                        <option value="{{ lst.id }}">
                            {{ lst.name }}{% if in_list %} (listede){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-outline-primary">
                    Ekle / Çıkar
                </button>
            </div>
        </form>


        <!-- Yorum formu -->
        <h5>Yorum Yaz</h5>
        <form method="post" class="mb-4">
            <div class="mb-3">
                <textarea name="review_text" rows="3" class="form-control"
                          placeholder="Düşüncelerini paylaş..."></textarea>
            </div>
            <button type="submit" class="btn btn-secondary">
                Yorum Gönder
            </button>
        </form>

        <!-- Yorumlar -->
        <h5>Yorumlar</h5>
        {% if reviews %}
            {% for rev in reviews %}
                <div class="border rounded p-2 mb-2">
                    <div class="small text-muted mb-1">
                        <strong>{{ rev.user.username }}</strong>
                        · {{ rev.created_at.strftime("%d.%m.%Y %H:%M") }}
                    </div>
                    <div>{{ rev.text }}</div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">Henüz yorum yok.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
